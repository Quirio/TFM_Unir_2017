AWSTemplateFormatVersion: "2010-09-09"
Resources:
  myVPC:
    Type: "AWS::CloudFormation::Stack"
    Properties: 
      TimeoutInMinutes: 60
      TemplateURL: "https://s3-eu-west-1.amazonaws.com/cloudformationtfm/vpc.yaml"
      Parameters:
        CidrBlock: "10.0.0.0/16"
        EnableDnsSupport: "false"
        EnableDnsHostnames: "false"
        InstanceTenacy: "dedicated"
    
  myPublicSubnet:
    Type: "AWS::CloudFormation::Stack"
    DependsOn: "myVPC"
    Properties:
      TimeoutInMinutes: 60
      TemplateURL: "https://s3-eu-west-1.amazonaws.com/cloudformationtfm/subnet.yaml"
      Parameters:
        CidrBlock: "10.0.0.0/24"      
        NameTag: "SubnetPublica" 
        VpcId: !GetAtt myVPC.Outputs.VPCid 
  
  myPublicRouteTable:
    Type: "AWS::CloudFormation::Stack"
    DependsOn: ["myVPC", "intGateway"]
    Properties:
      TimeoutInMinutes: 60
      TemplateURL: "https://s3-eu-west-1.amazonaws.com/cloudformationtfm/routeTable.yaml"
      Parameters:
        VpcId: !GetAtt myVPC.Outputs.VPCid 
        NameTag: "Public_Route_table"
        DestinationCidrBlock: "0.0.0.0/0"
        GatewayId: !GetAtt intGateway.Outputs.intGateway

  publicTableAssoc:
    Type: "AWS::CloudFormation::Stack"
    DependsOn: ["myPublicRouteTable", "myPublicSubnet"]
    Properties:
      TimeoutInMinutes: 60
      TemplateURL: "https://s3-eu-west-1.amazonaws.com/cloudformationtfm/subnetRouteTableAssociation.yaml"
      Parameters:
        SubnetId: !GetAtt myPublicSubnet.Outputs.SubnetId
        RouteTableId: !GetAtt myPublicRouteTable.Outputs.RouteTable
  
  intGateway:
    Type: "AWS::CloudFormation::Stack"
    DependsOn: "myVPC"
    Properties:   
      TimeoutInMinutes: 60
      TemplateURL: "https://s3-eu-west-1.amazonaws.com/cloudformationtfm/internetGateway.yaml"
      Parameters:
        VpcId: !GetAtt myVPC.Outputs.VPCid
        nameTag: "InternetGateway"              
     
  myPrivateSubnet:
    Type: "AWS::CloudFormation::Stack"
    DependsOn: "myVPC"
    Properties:
      TimeoutInMinutes: 60
      TemplateURL: "https://s3-eu-west-1.amazonaws.com/cloudformationtfm/subnet.yaml"
      Parameters:
        CidrBlock: "10.0.1.0/24"      
        NameTag: "SubnetPrivada"
        VpcId: !GetAtt myVPC.Outputs.VPCid 
  
  elasticIp:
    Type: "AWS::CloudFormation::Stack"
    DependsOn: "myVPC"
    Properties:
      TimeoutInMinutes: 60
      TemplateURL: "https://s3-eu-west-1.amazonaws.com/cloudformationtfm/elasticIp.yaml"
      Parameters:
        VpcId: !GetAtt myVPC.Outputs.VPCid
  
  natGateway:
    Type: "AWS::CloudFormation::Stack"
    DependsOn: ["elasticIp", "myPrivateSubnet"]
    Properties:
      TimeoutInMinutes: 60
      TemplateURL: "https://s3-eu-west-1.amazonaws.com/cloudformationtfm/natGateway.yaml"
      Parameters:
        AllocationId: !GetAtt elasticIp.Outputs.elasticIp
        SubnetId: !GetAtt myPrivateSubnet.Outputs.SubnetId
 
  privateTableAssoc:  
    Type: "AWS::CloudFormation::Stack"
    DependsOn: ["myPrivateRouteTable", "myPrivateSubnet"]
    Properties:
      TimeoutInMinutes: 60
      TemplateURL: "https://s3-eu-west-1.amazonaws.com/cloudformationtfm/subnetRouteTableAssociation.yaml"
      Parameters:
        SubnetId: !GetAtt myPrivateSubnet.Outputs.SubnetId
        RouteTableId: !GetAtt myPrivateRouteTable.Outputs.RouteTable
  
  myPrivateRouteTable:     
    Type: "AWS::CloudFormation::Stack"
    DependsOn: ["myVPC", "natGateway"]
    Properties:
      TimeoutInMinutes: 60
      TemplateURL: "https://s3-eu-west-1.amazonaws.com/cloudformationtfm/routeTableprivate.yaml"
      Parameters:
        VpcId: !GetAtt myVPC.Outputs.VPCid
        NameTag: "Private_Route_table"
        DestinationCidrBlock: "0.0.0.0/0"
        NatGatewayId: !GetAtt natGateway.Outputs.NatGateway
  
  publicSecurityGroup: 
    Type: "AWS::CloudFormation::Stack"
    DependsOn: ["myVPC"]
    Properties:
      TimeoutInMinutes: 60
      TemplateURL: "https://s3-eu-west-1.amazonaws.com/cloudformationtfm/securityGroup.yaml"
      Parameters:
        Name: "PublicSecurityGroup"
        Description: "Allow 80 port traffic"
        NameTag: "PublicSecurityGroup"
        VpcId: !GetAtt myVPC.Outputs.VPCid 
 
  publicEC2:
    Type: "AWS::CloudFormation::Stack"
    DependsOn: ["myPublicSubnet","publicSecurityGroup","publicTableAssoc"]
    Properties:
      TimeoutInMinutes: 60
      TemplateURL: "https://s3-eu-west-1.amazonaws.com/cloudformationtfm/ec2.yaml"
      Parameters:
        ImageId: "ami-ebd02392"
        KeyName: "TFMkey"
        InstanceType: "t2.micro"   
        NameTag: "PublicEc2"
        AvailabilityZone: myPublicSubnet.Outputs.AvailabilityZone
        SubnetId: myPublicSubnet.Outputs.SubnetId 
        
